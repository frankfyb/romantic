## 目标与范围
- 登录用户在编辑页保存当前工具配置到数据库，并生成可分享的短链接
- 访客打开分享链接后，以全屏、只读的预览模式展示配置效果
- 以 Supabase 作为配置存储；工具元信息与配置记录复用现有 `ToolService`

## 数据模型
- 表：`tool_metadata`（工具元信息）与 `tool_configs`（用户配置与分享）
- 字段建议：
  - `tool_metadata(tool_key, tool_name, default_config, is_active, created_at, updated_at)`
  - `tool_configs(id, tool_key, config, share_id, user_id, fingerprint, is_deleted, expires_at, created_at, updated_at)`
- 说明：
  - `share_id` 用于生成短链接；`expires_at` 控制分享有效期；`is_deleted` 支持逻辑删除

## 权限与安全
- Supabase RLS：
  - 插入/更新策略：仅登录用户可为自己插入/更新 `tool_configs`（`user_id == auth.uid()`）
  - 查询策略（分享页）：允许根据 `share_id` 查询公开配置，且 `is_deleted = false` 与 `expires_at` 未过期
- 校验：前端保存时附带 `userId`，服务器端（如改为 API 路由）需再次校验登录态

## 服务层改造
- 复用并增强 `src/services/supabase/toolService.ts`：
  - `getToolMetadata(toolKey)`：编辑页加载默认配置；已存在
  - `saveConfig(toolKey, config, options)`：插入 `tool_configs` 并返回 `shareId`；已存在，补充 `userId` 必填与异常处理
  - `getConfigByShareId(shareId)`：分享页查询并校验过期/删除；已存在，确保 `.or('expires_at.is.null,expires_at.gt.now()')`
- 可选：新增只读 API 路由 `/api/tools/share/[id]`，由服务器统一读取并返回配置，避免客户端直连 Supabase 时的 RLS差异

## 编辑页保存逻辑
- 入口：`src/app/rituals/[ritual]/page.tsx:58` 的 `generateShareLink`
- 行为：
  - 获取当前登录用户：`supabase.auth.getUser()`；若无登录，提示登录
  - 调用 `ToolService.saveConfig(ritual, config, { userId, expiresAt })`
  - 成功后拼接分享链接并复制到剪贴板：`/rituals/${ritual}/share/${shareId}`
- 交互：成功浮层提示；失败展示错误信息；按钮加载态

## 分享页展示逻辑（全屏）
- 入口：`src/app/rituals/[ritual]/share/[id]/page.tsx`
- 行为：
  - 读取 `ritual` 与 `id` 参数
  - 通过 `ToolService.getConfigByShareId(id)` 获取配置，并校验 `tool_key === ritual`
  - 渲染工具 UI：`getToolUI(ritual)`，传入 `config` 与 `isPreview=true`
- 全屏体验：工具 UI 内提供全屏按钮（参考 `warm-text-card` 的 `DisplayUI` 全屏切换），分享模式下隐藏配置面板

## 工具注册中心
- 入口：`src/config/toolsRegistry.ts`
- 职责：
  - `toolUIRegistry`：`tool_key` → `DisplayUI` 映射
  - `getToolUI(toolKey)`：获取 UI 组件
  - `getToolDefaultConfig(toolKey)` / `getToolName(toolKey)`：编辑页缺省回退时使用（已接入）

## 中间件与路由权限
- 编辑页需登录：可在现有 `src/middleware.ts:21-30` 受保护路由列表加入 `/rituals/[ritual]` 的编辑入口（仅编辑路径受限，分享路径开放）
- 分享页开放访问：`/rituals/[ritual]/share/[id]` 不拦截

## 代码要点（示例片段）
- 保存配置（编辑页）：
```ts
// 位置：src/app/rituals/[ritual]/page.tsx 内
const { data: { user } } = await supabase.auth.getUser();
if (!user) throw new Error('请先登录');
const { shareId } = await ToolService.saveConfig(ritual, config, {
  userId: user.id,
  expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString(),
});
const shareLink = `${window.location.origin}/rituals/${ritual}/share/${shareId}`;
await navigator.clipboard.writeText(shareLink);
```
- 分享页查询：
```ts
// 位置：src/app/rituals/[ritual]/share/[id]/page.tsx
const rec = await ToolService.getConfigByShareId(shareId);
if (!rec || rec.tool_key !== ritual) notFound();
const DisplayUI = getToolUI(ritual);
return <DisplayUI config={rec.config} isPreview />;
```

## 测试验证
- 单元测试：
  - `ToolService.saveConfig`：正确写入并返回 `shareId`
  - `ToolService.getConfigByShareId`：过期/删除的记录不可见
- 手动验证：
  - 登录后在编辑页保存生成分享链接并复制
  - 访客打开分享链接能看到全屏预览，无配置面板

## 性能与优化
- `getConfigByShareId` 结果缓存（如需，可使用 `cache()` 或应用端缓存策略）
- 分享页仅渲染展示组件，不加载编辑依赖

## 交付项
- 保持现有 `ToolService` 方案，补充登录校验与错误提示
- 编辑页与分享页交互完善（加载态、错误态、提示信息）
- 可选：提供只读 API 路由，便于后续调整 RLS 或服务端聚合
