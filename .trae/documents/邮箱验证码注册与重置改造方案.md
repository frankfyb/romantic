## 目标与产出
- 为邮箱验证码注册与忘记密码重置提供完整的前后端实现，集成到现有页面与组件。
- 连接真实邮件服务发送验证码，并加入基本风控与过期/使用状态管理。
- 优化并统一 `LoginContent.tsx`、`RegisterContent.tsx`、`ResetPasswordContent.tsx` 三个业务组件交互体验。

## 现状与缺口
- 已有：`Next.js App Router`、`NextAuth + Prisma`、`EmailVerifyCode` 模型、`/api/users/register` 与 `/api/auth/password/confirm` 路由。
- 缺口：`/api/auth/email/code` 发送验证码路由未实现；前端组件未统一封装验证码发送与倒计时；邮件发送需与真实 SMTP 对接与内容模板化；风控（频率限制）与验证码使用/过期的统一服务函数。

## 前端改造
- 统一交互要点
  - 所有发送验证码入口使用统一调用：`POST /api/auth/email/code`，`body: { email, type: "LOGIN" | "REGISTER" | "RESET" }`。
  - 发送后倒计时 60s、按钮禁用、错误提示与成功提示统一；邮箱格式与必填校验。
- `src/components/business/LoginContent.tsx`
  - 保留两种登录方式：`邮箱+密码` 与 `邮箱+验证码`；验证码登录调用 `signIn("email-code")`，密码登录调用 `signIn("email-password")`。
  - 整合“发送验证码”按钮至验证码登录 Tab，调用 `/api/auth/email/code`，`type="LOGIN"`。
- `src/components/business/RegisterContent.tsx`
  - 表单字段：`email`、`name`、`password`、`confirmPassword`、`code`；
  - “发送验证码”按钮调用 `/api/auth/email/code`，`type="REGISTER"`；
  - 提交到 `POST /api/users/register`，传入 `code`；路由服务端校验并创建用户（`bcrypt.hash`），标记验证码为已使用。
- `src/components/business/ResetPasswordContent.tsx`
  - 字段：`email`、`newPassword`、`confirmPassword`、`code`；
  - “发送验证码”按钮调用 `/api/auth/email/code`，`type="RESET"`；
  - 提交到 `POST /api/auth/password/confirm`，后台校验验证码、更新 `passwordHash` 并标记验证码为已使用。
- 页面集成
  - `src/app/auth/login/page.tsx` 引入并渲染 `LoginContent`。
  - `src/app/auth/register/page.tsx`（若现为 `register-complete`，则改为常规注册页）引入 `RegisterContent`。
  - `src/app/auth/reset-password/page.tsx` 引入 `ResetPasswordContent`。

## 后端改造
- 新增 `POST /api/auth/email/code` 路由：`src/app/api/auth/email/code/route.ts`
  - 入参：`email`、`type`（`LOGIN`/`REGISTER`/`RESET`/`VERIFY`）。
  - 逻辑：
    - 校验邮箱格式与必要性；基本频率限制（同邮箱 60s 冷却）。
    - 生成 6 位验证码，`expires=10min`，Prisma `upsert` 到 `EmailVerifyCode`（`isUsed=false`）。
    - 调用邮件发送工具（`nodemailer`），使用模板化主题与内容；不在日志中打印验证码。
    - 返回 `{ ok: true }` 或错误信息。
- 核心验证码服务函数
  - `src/services/emailCode.ts`
    - `createCode({ email, type })`：生成/写入；
    - `verifyCode({ email, type, code })`：校验有效期、未使用、匹配；
    - `markUsed({ email, type, code })`：标记为已使用。
- 路由联动校验
  - `src/app/api/users/register/route.ts`：在创建用户前 `verifyCode(type="REGISTER")`，成功后 `markUsed`；冲突处理邮箱唯一约束。
  - `src/app/api/auth/password/confirm/route.ts`：校验 `type="RESET"` 的验证码，然后更新 `passwordHash` 并 `markUsed`。
- NextAuth 校正
  - 确认 `src/app/api/auth/[...nextauth]/route.ts` 已配置 `CredentialsProvider`：`email-code` 使用 `type="LOGIN"` 的验证码校验，`email-password` 使用 `bcrypt.compare`。

## 邮件服务配置
- 使用 `nodemailer` 直连 SMTP。
- 环境变量：
  - `SMTP_HOST`、`SMTP_PORT`、`SMTP_SECURE`、`SMTP_USER`、`SMTP_PASS`、`SMTP_FROM_NAME`、`SMTP_FROM_EMAIL`。
- 工具与模板：
  - `src/lib/email/transporter.ts`：创建并缓存 `nodemailer` transporter（读取 env，启动时校验缺失变量）。
  - `src/lib/email/templates.ts`：按 `type` 返回主题与正文（含有效期说明与安全提示）。

## 安全与风控
- 冷却与限频：同邮箱 60s 冷却、每小时上限（如 5 次）。
- 有效期：默认 10 分钟；过期不可用。
- 使用状态：校验后必须 `markUsed`，避免复用。
- 隐私：不在日志与错误信息中暴露完整验证码；邮件内容包含品牌与申明。

## 集成与路由
- 组件与页面保持现有 App Router 结构，`SessionProvider basePath="/api/auth"` 保持不变。
- 中间件：继续使用 `next-auth/jwt` 保护路由（`/profile` 等）；认证成功后从 `/auth/*` 跳转首页。

## 验证与测试
- 开发环境联调：
  - 使用已有 `GET /api/dev/email/get-code` 辅助查看验证码（仅开发环境）。
  - 前端发送验证码倒计时与禁用状态验证。
- 单元/集成测试：
  - 验证码服务函数：创建/校验/使用状态与过期。
  - 注册与重置密码路由：正确/错误验证码分支；邮箱唯一约束分支。
- 手测用例：
  - 注册：发送验证码→注册成功→再次注册提示邮箱存在。
  - 登录：验证码登录与密码登录均可用。
  - 重置：发送验证码→更新密码→旧密码不可登录，新密码可登录。

## 交付清单
- 新增/更新文件：
  - `src/app/api/auth/email/code/route.ts`
  - `src/services/emailCode.ts`
  - `src/lib/email/transporter.ts`
  - `src/lib/email/templates.ts`
  - `src/components/business/LoginContent.tsx`
  - `src/components/business/RegisterContent.tsx`
  - `src/components/business/ResetPasswordContent.tsx`
  - 视情况修订：`src/app/auth/login/page.tsx`、`src/app/auth/register/page.tsx`、`src/app/auth/reset-password/page.tsx`、`src/app/api/users/register/route.ts`、`src/app/api/auth/password/confirm/route.ts`、`src/app/api/auth/[...nextauth]/route.ts`
- 环境变量配置说明与邮件服务联调指南。

请确认该方案；确认后我将开始实现并提交可运行代码与测试。